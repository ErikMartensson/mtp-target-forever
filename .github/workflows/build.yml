name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build configuration'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

env:
  BUILD_TYPE: ${{ inputs.build_type || 'Release' }}
  # Enable vcpkg binary caching
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  # ============================================
  # Build Dependencies (cached)
  # ============================================
  build-deps:
    name: Build Dependencies
    runs-on: windows-2022
    outputs:
      deps-cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      ryzomcore-cache-hit: ${{ steps.cache-ryzomcore.outputs.cache-hit }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        run: choco install ninja -y

      # Download external dependencies (RyzomCore needs these)

      - name: Cache Dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: C:/external
          key: deps-v1

      - name: Download External Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "Downloading Ryzom external dependencies (1.3GB)..."
          $url = "https://cdn.ryzom.dev/core/2022q2_external_v143_x64.7z"
          $output = "C:/external.7z"

          # Download with progress disabled for speed
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
          $ProgressPreference = 'Continue'

          # Create target directory
          New-Item -ItemType Directory -Force -Path "C:/external"

          Write-Host "Extracting dependencies to C:/external..."
          7z x $output -oC:/external -y

          # List what was extracted (both files and directories)
          Write-Host "Extracted contents (directories):"
          Get-ChildItem C:/external -Directory | Select-Object Name
          Write-Host "Extracted contents (files at root):"
          Get-ChildItem C:/external -File | Select-Object Name

          # RyzomCore requires CMakeLists.txt in external directory
          if (!(Test-Path "C:/external/CMakeLists.txt")) {
            Write-Warning "CMakeLists.txt not found in C:/external - checking for nested structure..."

            # Check if there's a nested "external" folder from the archive
            $nested = Get-ChildItem C:/external -Directory | Where-Object {
              Test-Path "$($_.FullName)/CMakeLists.txt"
            } | Select-Object -First 1

            if ($nested) {
              Write-Host "Found CMakeLists.txt in nested folder: $($nested.Name)"
              Write-Host "Moving contents up one level..."
              Get-ChildItem $nested.FullName | Move-Item -Destination "C:/external/" -Force
              Remove-Item $nested.FullName -Recurse -Force -ErrorAction SilentlyContinue
            } else {
              Write-Warning "No CMakeLists.txt found in any subdirectory"
              Write-Host "This external package may not be compatible with RyzomCore"
            }
          }

          # Cleanup archive to save space
          Remove-Item $output

          # ===========================================
          # REQUIRED FILES MANIFEST
          # Load from shared deps-manifest.ps1 (single source of truth)
          # ===========================================
          . "${{ github.workspace }}/scripts/deps-manifest.ps1"
          $allRequiredFiles = Get-AllRequiredFiles

          Write-Host "`n=== Verifying required files after extraction ==="
          $missingFiles = @()
          foreach ($file in $allRequiredFiles) {
            $fullPath = "C:/external/$file"
            if (!(Test-Path $fullPath)) {
              $missingFiles += $file
              Write-Host "[MISSING] $file"
            }
          }
          if ($missingFiles.Count -gt 0) {
            Write-Error "Missing $($missingFiles.Count) required files after extraction!"
            exit 1
          }
          Write-Host "All $($allRequiredFiles.Count) required files present"

          # Remove all OpenSSL libs except the specific release ones we need
          # (FindOpenSSL returns "optimized;...;debug;..." format which modern CMake
          # doesn't allow in INTERFACE_LINK_LIBRARIES)
          Write-Host "`nCleaning OpenSSL libs - keeping only release MSVC libs..."
          $keepLibs = @(
            "libcrypto64MD.lib",
            "libssl64MD.lib"
          )
          # Delete all .lib files in openssl/lib recursively, except the ones we want (by filename)
          Get-ChildItem "C:/external/openssl/lib" -Recurse -Filter "*.lib" | ForEach-Object {
            if ($keepLibs -notcontains $_.Name) {
              Remove-Item $_.FullName -Force
              Write-Host "Removed: $($_.FullName)"
            } else {
              Write-Host "Kept: $($_.FullName)"
            }
          }

          # === AGGRESSIVE CLEANUP to reduce cache size ===
          Write-Host "`n=== Aggressive cleanup to reduce cache size ==="
          $beforeSize = (Get-ChildItem "C:/external" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "Size before cleanup: $([math]::Round($beforeSize, 2)) MB"

          # Remove unused library directories (saves ~3.4GB)
          Write-Host "`nRemoving unused libraries (from manifest)..."
          $unusedLibs = Get-UnusedLibraries
          foreach ($lib in $unusedLibs) {
            $libPath = "C:/external/$lib"
            if (Test-Path $libPath) {
              $libSize = (Get-ChildItem $libPath -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
              Remove-Item $libPath -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "  Removed: $lib ($([math]::Round($libSize, 1)) MB)"
            }
          }

          # Remove all debug symbol files (.pdb)
          Write-Host "`nRemoving .pdb debug symbols..."
          Get-ChildItem "C:/external" -Recurse -Filter "*.pdb" -ErrorAction SilentlyContinue |
            Remove-Item -Force -ErrorAction SilentlyContinue

          # Remove documentation, samples, tests, examples directories
          Write-Host "Removing docs, samples, tests, examples..."
          Get-ChildItem "C:/external" -Recurse -Directory -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -match "^(doc|docs|documentation|sample|samples|test|tests|example|examples|man|manual|tutorial|tutorials|demo|demos)$" } |
            Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          # Remove known debug libraries explicitly
          # NOTE: Don't use regex patterns like "d\.lib$" - they match luabind.lib (the 'd' in 'bind')
          Write-Host "Removing known debug libraries..."
          $knownDebugLibs = @(
            "luabind/lib/luabindd.lib",
            "libxml2/lib/libxml2d.lib",
            "zlib/lib/zlibd.lib",
            "libpng/lib/libpng16d.lib",
            "freetype/lib/freetyped.lib"
          )
          foreach ($lib in $knownDebugLibs) {
            $fullPath = "C:/external/$lib"
            if (Test-Path $fullPath) {
              Remove-Item $fullPath -Force -ErrorAction SilentlyContinue
              Write-Host "Removed debug lib: $lib"
            }
          }

          # Remove boost debug libraries (saves ~500MB)
          Write-Host "Removing boost debug libraries..."
          $boostDebugLibs = Get-ChildItem "C:/external/boost/lib" -Filter "*-gd-*.lib" -ErrorAction SilentlyContinue
          if ($boostDebugLibs) {
            $boostDebugSize = ($boostDebugLibs | Measure-Object -Property Length -Sum).Sum / 1MB
            $boostDebugLibs | Remove-Item -Force -ErrorAction SilentlyContinue
            Write-Host "  Removed $($boostDebugLibs.Count) boost debug libs ($([math]::Round($boostDebugSize, 1)) MB)"
          }

          # Remove CMake package config files (not needed at runtime)
          Write-Host "Removing CMake config files..."
          Get-ChildItem "C:/external" -Recurse -Directory -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -eq "cmake" -or $_.Name -eq "pkgconfig" } |
            Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          # Remove .exe tools we don't need (xml tools, curl.exe, etc.)
          Write-Host "Removing unnecessary executables..."
          $keepExes = @("lua.exe", "luac.exe")  # Keep Lua interpreter
          Get-ChildItem "C:/external" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue |
            Where-Object { $keepExes -notcontains $_.Name } |
            Remove-Item -Force -ErrorAction SilentlyContinue

          # Remove static libraries we don't need
          # Note: We use libcurl_imp.lib (DLL import lib), not libcurl.lib (static)
          Write-Host "Removing unnecessary static libraries..."
          $staticLibsToRemove = @(
            "C:/external/zlib/lib/zlibstatic.lib"    # We use zlib.lib (DLL import)
          )
          foreach ($lib in $staticLibsToRemove) {
            if (Test-Path $lib) {
              Remove-Item $lib -Force -ErrorAction SilentlyContinue
              Write-Host "Removed: $lib"
            }
          }

          $afterSize = (Get-ChildItem "C:/external" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "`nSize after cleanup: $([math]::Round($afterSize, 2)) MB"
          Write-Host "Saved: $([math]::Round($beforeSize - $afterSize, 2)) MB"

          # ===========================================
          # VERIFY REQUIRED FILES AFTER CLEANUP
          # This ensures cleanup didn't accidentally delete anything we need
          # ===========================================
          Write-Host "`n=== Verifying required files after cleanup ==="
          $missingAfterCleanup = @()
          foreach ($file in $allRequiredFiles) {
            $fullPath = "C:/external/$file"
            if (!(Test-Path $fullPath)) {
              $missingAfterCleanup += $file
              Write-Host "[DELETED BY CLEANUP] $file"
            }
          }
          if ($missingAfterCleanup.Count -gt 0) {
            Write-Error "Cleanup deleted $($missingAfterCleanup.Count) required files! Fix the cleanup rules."
            exit 1
          }
          Write-Host "All $($allRequiredFiles.Count) required files still present after cleanup"

          Write-Host "`nExternal dependencies ready at C:/external"
          Write-Host "Final structure:"
          Get-ChildItem C:/external | Select-Object Mode, Name

      # Install ODE physics library (not in Ryzom external package)
      - name: Install ODE
        shell: pwsh
        run: |
          # Skip if ODE already exists from cache
          if (Test-Path "C:/external/ode/include/ode/ode.h") {
            Write-Host "ODE already installed, skipping..."
            exit 0
          }

          Write-Host "Installing ODE via vcpkg..."
          # vcpkg is pre-installed on GitHub Actions runners
          # Use x64-windows-static-md triplet: static library with dynamic CRT (/MD)
          # This matches how mtp_target_forever is built (dynamic CRT)
          vcpkg install ode:x64-windows-static-md

          # Copy to C:/external/ode for consistency
          $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
          if (-not $vcpkgRoot) {
            $vcpkgRoot = "C:\vcpkg"
          }

          $installedDir = "$vcpkgRoot\installed\x64-windows-static-md"
          if (Test-Path $installedDir) {
            New-Item -ItemType Directory -Force -Path "C:/external/ode/include"
            New-Item -ItemType Directory -Force -Path "C:/external/ode/lib"

            # Copy headers
            if (Test-Path "$installedDir/include/ode") {
              Copy-Item -Recurse "$installedDir/include/ode" "C:/external/ode/include/"
              Write-Host "Copied ODE headers"
            }

            # Copy libraries - ODE names vary: ode.lib, ode_double.lib, ode_doubles.lib
            # Copy all found libs and create a consistent name (ode_doubles.lib) for our CMake
            Get-ChildItem "$installedDir/lib" -Filter "ode*.lib" | ForEach-Object {
              Copy-Item $_.FullName "C:/external/ode/lib/"
              Write-Host "Copied: $($_.Name)"
              # Also copy as ode_doubles.lib if it has a different name
              if ($_.Name -ne "ode_doubles.lib") {
                Copy-Item $_.FullName "C:/external/ode/lib/ode_doubles.lib"
                Write-Host "Also copied as: ode_doubles.lib"
              }
            }

            Write-Host "`nODE installation complete:"
            Get-ChildItem "C:/external/ode" -Recurse | Select-Object FullName
          } else {
            Write-Error "vcpkg install directory not found: $installedDir"
          }
      # Build RyzomCore
      - name: Cache RyzomCore
        id: cache-ryzomcore
        uses: actions/cache@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-v1


      - name: Build RyzomCore
        if: steps.cache-ryzomcore.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          # Clean up any stale directory from failed cache restore
          if (Test-Path "C:/ryzomcore") {
            Remove-Item -Recurse -Force "C:/ryzomcore"
          }

          Write-Host "Cloning RyzomCore..."
          git clone --depth 1 https://github.com/ryzom/ryzomcore.git C:/ryzomcore

          Write-Host "Configuring RyzomCore..."
          cd C:/ryzomcore
          mkdir build
          cd build

          # Point to external dependencies via CMAKE_PREFIX_PATH
          $cmakePrefixPath = "C:/external/zlib;C:/external/libpng;C:/external/libjpeg;C:/external/curl;C:/external/openssl;C:/external/freetype;C:/external/ogg;C:/external/vorbis;C:/external/openal-soft;C:/external/boost;C:/external/lua;C:/external/luabind;C:/external/libxml2"

          # Use Ninja generator for faster builds
          # Find cl.exe using where.exe (more reliable than relying on PATH in cmake)
          $ninjaPath = "C:/Program Files/Microsoft Visual Studio/2022/Enterprise/Common7/IDE/CommonExtensions/Microsoft/CMake/Ninja/ninja.exe"
          $clPath = (Get-Command cl.exe -ErrorAction SilentlyContinue).Source
          if (-not $clPath) {
            # Fallback: use where.exe
            $clPath = (where.exe cl.exe 2>$null | Select-Object -First 1)
          }
          if (-not $clPath) {
            Write-Error "Could not find cl.exe! MSVC environment may not be set up correctly."
            exit 1
          }
          Write-Host "Found cl.exe at: $clPath"

          # IMPORTANT: Do NOT define LIBXML_STATIC!
          # The Ryzom external package provides libxml2 as a DLL (libxml2.dll + libxml2.lib import library).
          # When linking against a DLL:
          # - Without LIBXML_STATIC: xmlexports.h uses __declspec(dllimport) -> linker expects __imp_xmlFree
          # - With LIBXML_STATIC: xmlexports.h uses plain extern -> linker expects xmlFree (not in import lib!)
          # The import library (libxml2.lib) contains __imp_xmlFree, so we must NOT use LIBXML_STATIC.
          Write-Host "Using DLL linkage for libxml2 (no LIBXML_STATIC)"


          cmake .. -G Ninja `
            -DCMAKE_MAKE_PROGRAM="$ninjaPath" `
            -DCMAKE_C_COMPILER="$clPath" `
            -DCMAKE_CXX_COMPILER="$clPath" `
            -DCMAKE_BUILD_TYPE=Release `
            -DWITH_SOUND=ON `
            -DWITH_NEL=ON `
            -DWITH_NEL_TOOLS=OFF `
            -DWITH_NEL_TESTS=OFF `
            -DWITH_NEL_SAMPLES=OFF `
            -DWITH_RYZOM=OFF `
            -DWITH_RYZOM_CLIENT=OFF `
            -DWITH_RYZOM_SERVER=OFF `
            -DWITH_RYZOM_TOOLS=OFF `
            -DWITH_NELNS=OFF `
            -DWITH_SNOWBALLS=OFF `
            -DWITH_STATIC=ON `
            -DWITH_STATIC_LIBXML2=OFF `
            -DLIBXML2_DEFINITIONS="" `
            "-DCMAKE_PREFIX_PATH=$cmakePrefixPath" `
            -DLUA_INCLUDE_DIR=C:/external/lua/include `
            -DLUA_LIBRARIES=C:/external/lua/lib/lua51.lib `
            -DLUABIND_INCLUDE_DIR=C:/external/luabind/include `
            -DLUABIND_LIBRARY=C:/external/luabind/lib/luabind.lib `
            -DLUABIND_LIBRARIES=C:/external/luabind/lib/luabind.lib `
            -DLIBXML2_INCLUDE_DIR=C:/external/libxml2/include/libxml2 `
            -DLIBXML2_LIBRARY=C:/external/libxml2/lib/libxml2.lib `
            -DLIBXML2_LIBRARIES=C:/external/libxml2/lib/libxml2.lib `
            -DZLIB_INCLUDE_DIR=C:/external/zlib/include `
            -DZLIB_LIBRARIES=C:/external/zlib/lib/zlib.lib `
            -DZLIB_LIBRARY=C:/external/zlib/lib/zlib.lib `
            -DPNG_PNG_INCLUDE_DIR=C:/external/libpng/include `
            -DPNG_LIBRARY=C:/external/libpng/lib/libpng16.lib `
            -DJPEG_INCLUDE_DIR=C:/external/libjpeg/include `
            -DJPEG_LIBRARY=C:/external/libjpeg/lib/jpeg.lib `
            -DFREETYPE_INCLUDE_DIRS=C:/external/freetype/include/freetype2 `
            -DFREETYPE_LIBRARY=C:/external/freetype/lib/freetype.lib `
            -DOPENAL_INCLUDE_DIR=C:/external/openal-soft/include `
            -DOPENAL_LIBRARY=C:/external/openal-soft/lib/OpenAL32.lib `
            -DOGG_INCLUDE_DIR=C:/external/ogg/include `
            -DOGG_LIBRARY=C:/external/ogg/lib/ogg.lib `
            -DVORBIS_INCLUDE_DIR=C:/external/vorbis/include `
            -DVORBIS_LIBRARY=C:/external/vorbis/lib/vorbis.lib `
            -DVORBISFILE_LIBRARY=C:/external/vorbis/lib/vorbisfile.lib `
            -DBoost_INCLUDE_DIR=C:/external/boost/include `
            -DOPENSSL_ROOT_DIR=C:/external/openssl `
            -DOPENSSL_CRYPTO_LIBRARY=C:/external/openssl/lib/VC/libcrypto64MD.lib `
            -DOPENSSL_SSL_LIBRARY=C:/external/openssl/lib/VC/libssl64MD.lib `
            -DOPENSSL_LIBRARIES="C:/external/openssl/lib/VC/libcrypto64MD.lib;C:/external/openssl/lib/VC/libssl64MD.lib" `
            -DCMAKE_FIND_USE_SYSTEM_ENVIRONMENT_PATH=FALSE

          Write-Host "`nBuilding RyzomCore..."
          cmake --build . --parallel 4 --target nelmisc nelnet nel3d nelsound nelsnd_lowlevel nelgeorges nelligo
          cmake --build . --parallel 2 --target nel_drv_opengl_win nel_drv_openal_win

      - name: Verify RyzomCore Build
        if: steps.cache-ryzomcore.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          # Ninja outputs to lib/ and bin/ directly (no Release subdirectory)
          $required = @(
            "C:/ryzomcore/build/lib/nelmisc_r.lib",
            "C:/ryzomcore/build/lib/nel3d_r.lib",
            "C:/ryzomcore/build/lib/nelnet_r.lib",
            "C:/ryzomcore/build/lib/nelsound_r.lib",
            "C:/ryzomcore/build/lib/nelsnd_lowlevel_r.lib",
            "C:/ryzomcore/build/lib/nelgeorges_r.lib",
            "C:/ryzomcore/build/lib/nelligo_r.lib",
            "C:/ryzomcore/build/bin/nel_drv_opengl_win_r.dll",
            "C:/ryzomcore/build/bin/nel_drv_openal_win_r.dll"
          )
          $missing = @()
          foreach ($file in $required) {
            if (!(Test-Path $file)) {
              $missing += $file
            }
          }
          if ($missing.Count -gt 0) {
            Write-Error "RyzomCore build incomplete. Missing files:"
            $missing | ForEach-Object { Write-Error "  - $_" }
            exit 1
          }
          Write-Host "RyzomCore build verified successfully - all $($required.Count) files present"

  # ============================================
  # Build Client
  # ============================================
  build-client:
    name: Build Client
    needs: build-deps
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        run: choco install ninja -y

      - name: Restore RyzomCore Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-v1
          fail-on-cache-miss: true

      - name: Restore Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/external
          key: deps-v1

      - name: Verify Required Files
        shell: pwsh
        run: |
          # Use shared deps-manifest.ps1 (single source of truth)
          . "${{ github.workspace }}/scripts/deps-manifest.ps1"
          $env:MTPDEPS_PATH = "C:/external"
          Test-DepsInstalled -DepsPath "C:/external"

      - name: Configure CMake (Client)
        shell: pwsh
        run: |
          $shortHash = "${{ github.sha }}".Substring(0, 7)
          mkdir build-client
          cd build-client
          # Use shared cmake-config.ps1 (single source of truth)
          . "${{ github.workspace }}/scripts/cmake-config.ps1" -DepsPath "C:/external" -NelPath "C:/ryzomcore/build"
          $cmakeArgs = Get-ClientCMakeArgs
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release "-DMTPT_VERSION_SUFFIX=-$shortHash" @cmakeArgs

      - name: Build Client
        run: cmake --build build-client --parallel 4

      - name: Prepare Client Artifact
        shell: pwsh
        run: |
          # Use shared post-build.ps1 script (single source of truth)
          $env:MTPDEPS_PATH = "C:/external"
          & "${{ github.workspace }}/scripts/post-build.ps1" `
            -BuildType Client `
            -BuildDir "build-client/bin" `
            -DepsDir "C:/external" `
            -RyzomCoreDir "C:/ryzomcore" `
            -UseNinjaPaths

      - name: Upload Client Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MTP-Target-Forever-Client-win64
          path: |
            build-client/bin/mtp-target-forever.exe
            build-client/bin/*.dll
            build-client/bin/data/
            build-client/bin/*.cfg
          retention-days: 30

  # ============================================
  # Build Server
  # ============================================
  build-server:
    name: Build Server
    needs: build-deps
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        run: choco install ninja -y

      - name: Restore RyzomCore Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/ryzomcore
          key: ryzomcore-v1
          fail-on-cache-miss: true

      - name: Restore Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: C:/external
          key: deps-v1

      - name: Verify ODE Installation
        shell: pwsh
        run: |
          if (!(Test-Path "C:/external/ode/include/ode/ode.h")) {
            Write-Error "ODE header not found"
            exit 1
          }
          if (!(Test-Path "C:/external/ode/lib/ode_doubles.lib")) {
            Write-Error "ODE library not found"
            exit 1
          }
          Write-Host "ODE installation verified"

      - name: Configure CMake (Server)
        shell: pwsh
        run: |
          mkdir build-server
          cd build-server
          # Use shared cmake-config.ps1 (single source of truth)
          . "${{ github.workspace }}/scripts/cmake-config.ps1" -DepsPath "C:/external" -NelPath "C:/ryzomcore/build"
          $cmakeArgs = Get-ServerCMakeArgs
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release @cmakeArgs

      - name: Build Server
        run: cmake --build build-server --parallel 4

      - name: Prepare Server Artifact
        shell: pwsh
        run: |
          # Use shared post-build.ps1 script (single source of truth)
          $env:MTPDEPS_PATH = "C:/external"
          & "${{ github.workspace }}/scripts/post-build.ps1" `
            -BuildType Server `
            -BuildDir "build-server/bin" `
            -DepsDir "C:/external" `
            -RyzomCoreDir "C:/ryzomcore" `
            -UseNinjaPaths

      - name: Upload Server Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MTP-Target-Forever-Server-win64
          path: |
            build-server/bin/mtp-target-forever-srv.exe
            build-server/bin/*.dll
            build-server/bin/data/
            build-server/bin/*.cfg
          retention-days: 30

  # ============================================
  # Build Summary
  # ============================================
  build-summary:
    name: Build Summary
    needs: [build-client, build-server]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Client | ${{ needs.build-client.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Server | ${{ needs.build-server.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build type: **${{ env.BUILD_TYPE }}**" >> $GITHUB_STEP_SUMMARY
